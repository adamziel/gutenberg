name: PR Playground Preview - Publish

# Use workflow_run for privileged operations
# Runs with write permissions and access to secrets
# Operates on artifacts from the unprivileged build workflow
on:
  workflow_run:
    workflows: ["PR Playground Preview - Build"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  publish-preview:
    runs-on: ubuntu-latest
    # Only run if the build workflow succeeded and was triggered by a pull_request
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    outputs:
      artifact-url: ${{ steps.expose.outputs.artifact-url }}
      artifact-name: ${{ steps.expose.outputs.artifact-name }}
    steps:
      - name: Expose built artifact
        id: expose
        uses: WordPress/action-wp-playground-pr-preview/.github/actions/expose-artifact-on-public-url@main
        with:
          artifact-name: gutenberg-plugin-zip
          artifact-filename: gutenberg.zip
          pr-number: ${{ github.event.workflow_run.pull_requests[0].number }}
          commit-sha: ${{ github.event.workflow_run.head_sha }}
          artifact-source-run-id: ${{ github.event.workflow_run.id }}
          artifacts-to-keep: '2'

      - name: Post Playground preview button
        uses: WordPress/action-wp-playground-pr-preview@main
        with:
          mode: append-to-description
          blueprint: >-
            {"steps":[{"step":"installPlugin","pluginZipFile":{"resource":"url","url":"${{ steps.expose.outputs.artifact-url }}"}}]}
          pr-number: ${{ github.event.workflow_run.pull_requests[0].number }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
