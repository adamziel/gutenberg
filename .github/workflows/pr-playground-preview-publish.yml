name: PR Playground Preview - Publish

# Use workflow_run for privileged operations
# Runs with write permissions and access to secrets
# Operates on artifacts from the unprivileged build workflow
on:
  workflow_run:
    workflows: ["PR Playground Preview - Build"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  publish-preview:
    runs-on: ubuntu-latest
    # Only run if the build workflow succeeded and was triggered by a pull_request
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    outputs:
      artifact-url: ${{ steps.expose.outputs.artifact-url }}
      artifact-name: ${{ steps.expose.outputs.artifact-name }}
      blueprint: ${{ steps.blueprint.outputs.result }}
    steps:
      - name: Download PR metadata artifact
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
            });

            const metadataArtifact = artifacts.data.artifacts.find((artifact) => {
              return artifact.name.startsWith("pr-metadata-")
            });

            if (!metadataArtifact) {
              throw new Error('PR metadata artifact not found');
            }

            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: metadataArtifact.id,
              archive_format: 'zip',
            });

            const fs = require('fs');
            fs.writeFileSync('${{ github.workspace }}/pr-metadata.zip', Buffer.from(download.data));

      - name: Extract PR metadata
        id: pr-metadata
        run: |
          unzip pr-metadata.zip
          echo "pr-number=$(cat pr-number)" >> $GITHUB_OUTPUT
          echo "commit-sha=$(cat commit-sha)" >> $GITHUB_OUTPUT

      - name: Download plugin artifact
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
            });

            const pluginArtifact = artifacts.data.artifacts.find((artifact) => {
              return artifact.name.startsWith("gutenberg-plugin-zip-")
            });

            if (!pluginArtifact) {
              throw new Error('Plugin artifact not found');
            }

            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: pluginArtifact.id,
              archive_format: 'zip',
            });

            const fs = require('fs');
            fs.writeFileSync('${{ github.workspace }}/gutenberg-plugin.zip', Buffer.from(download.data));

      - name: Extract plugin
        run: |
          unzip gutenberg-plugin.zip

      - name: Expose built artifact
        id: expose
        uses: WordPress/action-wp-playground-pr-preview/.github/actions/expose-artifact-on-public-url@v2
        with:
          artifact-name: gutenberg-plugin-zip-${{ steps.pr-metadata.outputs.pr-number }}
          artifact-filename: gutenberg.zip
          pr-number: ${{ steps.pr-metadata.outputs.pr-number }}
          commit-sha: ${{ steps.pr-metadata.outputs.commit-sha }}
          artifacts-to-keep: '2'

      - name: Create blueprint
        id: blueprint
        uses: actions/github-script@v7
        with:
          script: |
            const blueprint = {
              steps: [
                {
                  step: "installPlugin",
                  pluginZipFile: {
                    resource: "url",
                    url: "${{ steps.expose.outputs.artifact-url }}"
                  }
                }
              ]
            };
            return JSON.stringify( blueprint );
          result-encoding: string

      - name: Post Playground preview button
        uses: WordPress/action-wp-playground-pr-preview@main
        with:
          mode: append-to-description
          blueprint: ${{ steps.blueprint.outputs.result }}
          pr-number: ${{ steps.pr-metadata.outputs.pr-number }}
